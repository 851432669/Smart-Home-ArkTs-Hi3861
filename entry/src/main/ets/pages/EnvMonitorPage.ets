import { AIComponent } from '../view/AIComponent';
import { EnvComponent } from '../view/EnvComponent';
import { SwiperComponent } from '../view/SwiperComponent';
import EnvironmentViewModel from '../viewmodel/EnvironmentViewModel';
import router from '@ohos.router';

@Component
export struct EnvMonitorPage {
  @Prop currentIndex: number = 2
  @State item: EnvironmentViewModel = new EnvironmentViewModel()
  @State chartHeight: number = 200
  onTabChange?: (index: number) => void

  aboutToAppear() {
    const LOCATION_ID = '101230201'
    console.info("ğŸŸ¢ é¡µé¢åŠ è½½ï¼Œå‡†å¤‡è°ƒç”¨å¤©æ°”æ¥å£")

    this.item.fetchWeather(LOCATION_ID).then(() => {
      console.info("âœ… å¤©æ°”æ•°æ®åŠ è½½å®Œæ¯•ï¼š", this.item.temp, this.item.hum, this.item.city)
    }).catch((err: Error) => {
      console.error("âŒ å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥", JSON.stringify(err))
    })
  }

  build() {
    Stack({ alignContent: Alignment.Top }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundImage($r('app.media.background'))
        .backgroundImageSize(ImageSize.Cover)
        .opacity(0.15)
      
      Column() {
        // é¡¶éƒ¨æ 
        Stack({ alignContent: Alignment.Center }) {
          Image($r('app.media.ai_green_128'))
            .width('100%')
            .height('100%')
            .objectFit(ImageFit.Cover)
            .opacity(0.2)
          
          Column({ space: 4 }) {
            Text("ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ")
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)

            Text("åŸå¸‚ï¼š" + (this.item.city || "å¦é—¨"))
              .fontSize(16)
              .fontColor(Color.White)
              .opacity(0.8)
          }
        }
        .width('100%')
        .height(80)
        .backgroundColor('#009688')
        .clip(true)
        
        // ä¸»ä½“å†…å®¹
        Scroll() {
          Column({ space: 16 }) {
            // æ“ä½œæ 
            Row() {
              Button() {
                Row({ space: 8 }) {
                  Image($r('app.media.foreground'))
                    .width(20)
                    .height(20)
                    .fillColor('#009688')
                  
                  Text('è¿”å›')
                    .fontSize(16)
                    .fontColor('#009688')
                }
              }
              .backgroundColor('rgba(0, 150, 136, 0.1)')
              .height(40)
              .borderRadius(20)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                if (this.onTabChange) {
                  this.onTabChange(0); // è¿”å›é¦–é¡µ
                } else {
                  router.back(); // å…¼å®¹ç‹¬ç«‹é¡µé¢æ¨¡å¼
                }
              })
              
              Blank()
              
              Button('åˆ·æ–°æ•°æ®')
                .height(40)
                .backgroundColor('#009688')
                .borderRadius(20)
                .fontSize(16)
                .onClick(() => {
                  this.item.fetchWeather('101230201')
                })
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 4 })
            
            // ç¯å¢ƒæ•°æ®å¡ç‰‡ - ç›´æ¥ä½¿ç”¨EnvComponent
            Column() {
              Row() {
                Text('ç¯å¢ƒå‚æ•°')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333')
                
                Blank()
                
                Row({ space: 6 }) {
                  Text('å®‰å…¨çŠ¶æ€ï¼š')
                    .fontSize(14)
                    .fontColor('#666')
                  
                  Text(this.item.stat === 0 ? 'å®‰å…¨' : this.item.stat === 1 ? 'è­¦å‘Š' : 'å±é™©')
                    .fontSize(14)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.item.stat === 0 ? '#4CAF50' : this.item.stat === 1 ? '#FFC107' : '#F44336')
                }
              }
              .width('100%')
              .padding({ bottom: 10 })

              EnvComponent({ item: this.item })
            }
            .width('92%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 2 })
            .margin({ left: '4%', right: '4%' })
            
            // è½®æ’­å›¾è¡¨å¡ç‰‡ - ç›´æ¥ä½¿ç”¨SwiperComponent
            Column() {
              Text('ç¯å¢ƒè¶‹åŠ¿')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 12 })
              
              SwiperComponent({ item: this.item })
            }
            .width('92%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 2 })
            .margin({ left: '4%', right: '4%' })
            
            // AIåˆ†æå¡ç‰‡ - ç›´æ¥ä½¿ç”¨AIComponent
            Column() {
              Text('AIæ™ºèƒ½åˆ†æ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 12 })
              
              AIComponent({ item: this.item })
            }
            .width('92%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 2 })
            .margin({ left: '4%', right: '4%' })
          }
          .width('100%')
          .padding({ bottom: 80 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      }
      .width('100%')
      .height('100%')
    }
    .backgroundColor('#F5F7FA')
  }
}

@Entry
@Component
struct EnvMonitorPageEntry {
  build() {
    Column() {
      EnvMonitorPage()
    }
  }
}

@Component
struct Card {
  @BuilderParam content: () => void

  build() {
    Column() {
      // ä½¿ç”¨ä¼ å…¥çš„æ„å»ºå™¨å‚æ•°
      this.content()
    }
    .width('92%')
    .borderRadius(16)
    .backgroundColor(Color.White)
    .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 2 })
    .margin({ left: '4%', right: '4%' })
    .padding(16)
  }
}
