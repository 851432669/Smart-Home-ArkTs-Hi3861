//
//
// import { WeatherService } from '../common/utils/WeatherService'
//
// export default class EnvironmentViewModel {
//   stat: number = 0
//   temp: number = 0
//   gas: number = 0
//   hum: number = 0
//
//   toPromptString(): string {
//     return `è¯·æ ¹æ®ä»¥ä¸‹ç¯å¢ƒå‚æ•°è¿›è¡Œå®‰å…¨è¯„ä¼°ä¸å»ºè®®ï¼š
// - ç©ºæ°”æ¸©åº¦: ${this.temp}â„ƒ
// - ç©ºæ°”æ¹¿åº¦: ${this.hum}%
// - å¯ç‡ƒæ°”ä½“æµ“åº¦: ${this.gas} PPM
// - å½“å‰å®‰å…¨çº§åˆ«: ${['å®‰å…¨', 'è­¦å‘Š', 'å±é™©'][this.stat]}`
//   }
//
//   async fetchXiamenWeather(): Promise<void> {
//     //æ¨¡æ‹Ÿå¯è¡Œ å‡½æ•°å·²ç»è°ƒç”¨
//     // this.temp = 25.5
//     // this.hum = 65
//     // this.gas = 120
//     // this.stat = 1
//     console.info("ğŸŸ¡ å¼€å§‹è·å–å¦é—¨å¤©æ°”...")
//     const response = await WeatherService.getCurrentWeather('101230201')
//     console.info("ğŸ”µ å“åº”å†…å®¹:", JSON.stringify(response))
//
//     if (response && response.now) {
//       this.temp = parseFloat(response.now.temp)
//       this.hum = parseFloat(response.now.humidity)
//       this.gas = Math.floor(Math.random() * 100)
//
//       if (this.gas < 100) this.stat = 0
//       else if (this.gas < 200) this.stat = 1
//       else this.stat = 2
//     } else {
//       console.warn("âš ï¸ æ— å¤©æ°”æ•°æ®è¿”å›")
//     }
//
//
//   }
//
//
// }
//
//
//
//
//
import { WeatherService } from '../common/utils/WeatherService'

export default class EnvironmentViewModel {
  city: string = 'æœªçŸ¥'
  stat: number = 0
  temp: number = 0
  gas: number = 0
  hum: number = 0
  weather: string = 'æ™´' // å¤©æ°”ç±»å‹
  weatherCode: string = '100' // å¤©æ°”ä»£ç 
  isNight: boolean = false // æ˜¯å¦å¤œé—´

  toPromptString(): string {
    return `è¯·æ ¹æ®ä»¥ä¸‹ç¯å¢ƒå‚æ•°è¿›è¡Œå®‰å…¨è¯„ä¼°ä¸å»ºè®®ï¼š
- ç©ºæ°”æ¸©åº¦: ${this.temp}â„ƒ
- ç©ºæ°”æ¹¿åº¦: ${this.hum}%
- å¯ç‡ƒæ°”ä½“æµ“åº¦: ${this.gas} PPM
- å½“å‰å®‰å…¨çº§åˆ«: ${['å®‰å…¨', 'è­¦å‘Š', 'å±é™©'][this.stat]}`
  }

  async fetchWeather(locationId: string): Promise<void> {
    console.info(`ğŸŸ¡ å¼€å§‹è·å–å¤©æ°” (${locationId})...`)
    const response = await WeatherService.getCurrentWeather(locationId)
    console.info("ğŸ”µ å¤©æ°”å“åº”å†…å®¹:", JSON.stringify(response))

    if (response && response.now) {
      this.temp = parseFloat(response.now.temp)
      this.hum = parseFloat(response.now.humidity)
      this.gas = Math.floor(Math.random() * 100)
      
      // è®¾ç½®åŸå¸‚åç§°
      this.city = "å¦é—¨"
      
      // è®¾ç½®å¤©æ°”ä»£ç å’Œç±»å‹
      if (response.now.icon) {
        this.weatherCode = response.now.icon
      }
      if (response.now.text) {
        this.weather = response.now.text
      }

      // åˆ¤æ–­æ˜¯å¦ä¸ºå¤œé—´
      const now = new Date()
      const hours = now.getHours()
      this.isNight = hours < 6 || hours >= 18

      if (this.gas < 100) this.stat = 0
      else if (this.gas < 200) this.stat = 1
      else this.stat = 2
    } else {
      console.warn("âš ï¸ æ— å¤©æ°”æ•°æ®è¿”å›")
    }
  }

  // è·å–å¤©æ°”å›¾æ ‡
  getWeatherIcon(): Resource {
    console.info(`è·å–å¤©æ°”å›¾æ ‡: ä»£ç =${this.weatherCode}, å¤©æ°”=${this.weather}, å¤œé—´=${this.isNight}`)
    
    // æ ¹æ®å¤©æ°”ä»£ç å’Œæ˜¯å¦å¤œé—´è¿”å›å¯¹åº”å›¾æ ‡
    if (this.weatherCode.startsWith('10')) { // æ™´
      if (this.isNight) {
        return $r('app.media.nightsunny')
      } else {
        return $r('app.media.sunny')
      }
    } else if (this.weatherCode.startsWith('11') || this.weatherCode.startsWith('12') || this.weatherCode.startsWith('13')) { // å¤šäº‘
      return $r('app.media.cloudy')
    } else if (this.weatherCode.startsWith('3')) { // é›¨
      return $r('app.media.rainy')
    } else if (this.weatherCode.startsWith('4')) { // é›ª
      return $r('app.media.snowy')
    } else if (this.weatherCode.startsWith('2')) { // é˜´
      return $r('app.media.cloudy')
    } else if (this.weatherCode.startsWith('9')) { // å¤§é£
      return $r('app.media.cloudy')
    } else if (this.weatherCode.startsWith('30')) { // é›¾éœ¾
      return $r('app.media.cloudy')
    } else if (this.weatherCode.startsWith('5')) { // éœ¾
      return $r('app.media.cloudy')
    } else if (this.weatherCode.startsWith('6') || this.weatherCode.startsWith('7')) { // é›·ç”µ
      return $r('app.media.thunder')
    } else {
      // é»˜è®¤å›¾æ ‡
      console.info(`æœªåŒ¹é…åˆ°å¤©æ°”å›¾æ ‡ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡: ${this.weatherCode}`)
      return $r('app.media.weather')
    }
  }
}
